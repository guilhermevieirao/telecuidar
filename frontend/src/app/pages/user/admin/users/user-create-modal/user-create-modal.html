@if (isOpen) {
  <div class="modal-backdrop" (click)="onBackdropClick()">
    <div class="modal" (click)="$event.stopPropagation()">
      <!-- Etapa 1: Seleção do tipo de usuário -->
      @if (step === 1) {
        <div class="modal__header">
          <div class="modal__header-content">
            <app-icon name="user" [size]="24" />
            <h2 class="modal__title">Criar Novo Usuário</h2>
          </div>
          <button
            type="button"
            class="modal__close"
            (click)="onCancel()"
            aria-label="Fechar"
          >
            <app-icon name="close" [size]="24" />
          </button>
        </div>

        <div class="modal__body">
          <p class="modal__description">Selecione o tipo de usuário que deseja criar:</p>

          <div class="role-cards">
            <button
              type="button"
              class="role-card"
              (click)="selectRole('PATIENT')"
            >
              <div class="role-card__icon role-card__icon--patient">
                <app-icon name="user" [size]="32" />
              </div>
              <h3 class="role-card__title">Paciente</h3>
              <p class="role-card__description">{{ getRoleDescription('PATIENT') }}</p>
            </button>

            <button
              type="button"
              class="role-card"
              (click)="selectRole('PROFESSIONAL')"
            >
              <div class="role-card__icon role-card__icon--professional">
                <app-icon name="users" [size]="32" />
              </div>
              <h3 class="role-card__title">Profissional</h3>
              <p class="role-card__description">{{ getRoleDescription('PROFESSIONAL') }}</p>
            </button>

            <button
              type="button"
              class="role-card"
              (click)="selectRole('ADMIN')"
            >
              <div class="role-card__icon role-card__icon--admin">
                <app-icon name="shield" [size]="32" />
              </div>
              <h3 class="role-card__title">Administrador</h3>
              <p class="role-card__description">{{ getRoleDescription('ADMIN') }}</p>
            </button>

            <button
              type="button"
              class="role-card"
              (click)="selectRole('ASSISTANT')"
            >
              <div class="role-card__icon role-card__icon--assistant">
                <app-icon name="phone" [size]="32" />
              </div>
              <h3 class="role-card__title">Assistente</h3>
              <p class="role-card__description">{{ getRoleDescription('ASSISTANT') }}</p>
            </button>
          </div>
        </div>

        <div class="modal__footer">
          <app-button
            [variant]="'outline'"
            (click)="onCancel()"
          >
            Cancelar
          </app-button>
        </div>
      }

      <!-- Etapa 2: Preenchimento dos dados -->
      @if (step === 2 && selectedRole) {
        <div class="modal__header">
          <div class="modal__header-content">
            <button
              type="button"
              class="modal__back"
              (click)="goBackToRoleSelection()"
              aria-label="Voltar"
            >
              <app-icon name="arrow-left" [size]="20" />
            </button>
            <div class="modal__header-icon" [class]="'modal__header-icon--' + selectedRole">
              <app-icon [name]="getRoleIcon(selectedRole)" [size]="20" />
            </div>
            <h2 class="modal__title">Criar {{ getRoleLabel(selectedRole) }}</h2>
          </div>
          <button
            type="button"
            class="modal__close"
            (click)="onCancel()"
            aria-label="Fechar"
          >
            <app-icon name="close" [size]="24" />
          </button>
        </div>

        <div class="modal__body">
          <p class="modal__description">
            Preencha os dados do novo usuário. Todos os campos são obrigatórios.
          </p>

          <form [formGroup]="userForm" class="user-form">
            <div class="user-form__row">
              <div class="user-form__field">
                <label for="create-user-name" class="user-form__label">Nome *</label>
                <input
                  id="create-user-name"
                  type="text"
                  class="user-form__input"
                  [class.user-form__input--error]="userForm.get('name')?.invalid && userForm.get('name')?.touched"
                  formControlName="name"
                  placeholder="Digite o nome"
                />
                @if (getErrorMessage('name')) {
                  <span class="user-form__error">{{ getErrorMessage('name') }}</span>
                }
              </div>

              <div class="user-form__field">
                <label for="create-user-lastname" class="user-form__label">Sobrenome *</label>
                <input
                  id="create-user-lastname"
                  type="text"
                  class="user-form__input"
                  [class.user-form__input--error]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched"
                  formControlName="lastName"
                  placeholder="Digite o sobrenome"
                />
                @if (getErrorMessage('lastName')) {
                  <span class="user-form__error">{{ getErrorMessage('lastName') }}</span>
                }
              </div>
            </div>

            <div class="user-form__field">
              <label for="create-user-email" class="user-form__label">
                E-mail *
              </label>
              <input
                id="create-user-email"
                type="email"
                class="user-form__input"
                [class.user-form__input--error]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
                formControlName="email"
                placeholder="Digite o e-mail"
              />
              @if (getErrorMessage('email')) {
                <span class="user-form__error">{{ getErrorMessage('email') }}</span>
              }
            </div>

            <div class="user-form__row">
              <div class="user-form__field">
                <label for="create-user-cpf" class="user-form__label">CPF *</label>
                <input
                  id="create-user-cpf"
                  type="text"
                  class="user-form__input"
                  [class.user-form__input--error]="userForm.get('cpf')?.invalid && userForm.get('cpf')?.touched"
                  formControlName="cpf"
                  placeholder="000.000.000-00"
                  appCpfMask
                />
                @if (getErrorMessage('cpf')) {
                  <span class="user-form__error">{{ getErrorMessage('cpf') }}</span>
                }
              </div>

              <div class="user-form__field">
                <label for="create-user-phone" class="user-form__label">Telefone *</label>
                <input
                  id="create-user-phone"
                  type="tel"
                  class="user-form__input"
                  [class.user-form__input--error]="userForm.get('phone')?.invalid && userForm.get('phone')?.touched"
                  formControlName="phone"
                  placeholder="(00) 00000-0000"
                  appPhoneMask
                />
                @if (getErrorMessage('phone')) {
                  <span class="user-form__error">{{ getErrorMessage('phone') }}</span>
                }
              </div>
            </div>

            <div class="user-form__row">
              <div class="user-form__field">
                <label for="create-user-password" class="user-form__label">
                  Senha *
                </label>
                <div class="user-form__password-wrapper">
                  <input
                    id="create-user-password"
                    [type]="showPassword ? 'text' : 'password'"
                    class="user-form__input"
                    [class.user-form__input--error]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
                    formControlName="password"
                    placeholder="Digite a senha"
                  />
                  <button type="button" class="user-form__password-toggle" (click)="showPassword = !showPassword">
                    <app-icon [name]="showPassword ? 'eye-off' : 'eye'" [size]="18" />
                  </button>
                </div>
                @if (getErrorMessage('password')) {
                  <span class="user-form__error">{{ getErrorMessage('password') }}</span>
                }
              </div>

              <div class="user-form__field">
                <label for="create-user-confirm-password" class="user-form__label">
                  Confirmar Senha *
                </label>
                <div class="user-form__password-wrapper">
                  <input
                    id="create-user-confirm-password"
                    [type]="showConfirmPassword ? 'text' : 'password'"
                    class="user-form__input"
                    [class.user-form__input--error]="userForm.get('confirmPassword')?.invalid && userForm.get('confirmPassword')?.touched"
                    formControlName="confirmPassword"
                    placeholder="Confirme a senha"
                  />
                  <button type="button" class="user-form__password-toggle" (click)="showConfirmPassword = !showConfirmPassword">
                    <app-icon [name]="showConfirmPassword ? 'eye-off' : 'eye'" [size]="18" />
                  </button>
                </div>
                @if (getErrorMessage('confirmPassword')) {
                  <span class="user-form__error">{{ getErrorMessage('confirmPassword') }}</span>
                }
              </div>
            </div>

            @if (userForm.get('password')?.value) {
              <div class="user-form__password-strength">
                <app-password-strength [password]="userForm.get('password')?.value" />
              </div>
            }

            <!-- Switch de Modo de Criação -->
            <div class="user-form__mode-switch">
              <label class="mode-switch">
                <span class="mode-switch__label" [class.mode-switch__label--active]="creationMode === 'manual'">Criação Manual</span>
                <button
                  type="button"
                  class="mode-switch__toggle"
                  [class.mode-switch__toggle--active]="creationMode === 'link'"
                  (click)="toggleCreationMode()"
                  aria-label="Alternar modo de criação"
                >
                  <span class="mode-switch__slider"></span>
                </button>
                <span class="mode-switch__label" [class.mode-switch__label--active]="creationMode === 'link'">Criação por Link</span>
              </label>
            </div>

            <!-- Campo de Validade do Link -->
            @if (creationMode === 'link') {
              <div class="user-form__field">
                <label for="link-validity" class="user-form__label">Validade do Link (dias)</label>
                <input
                  id="link-validity"
                  type="number"
                  class="user-form__input"
                  [(ngModel)]="linkValidity"
                  [ngModelOptions]="{standalone: true}"
                  name="linkValidity"
                  min="1"
                  max="365"
                  placeholder="7"
                />
                <span class="user-form__hint">O link expirará após {{ linkValidity }} {{ linkValidity === 1 ? 'dia' : 'dias' }}</span>
              </div>
            }
          </form>
        </div>

        <div class="modal__footer modal__footer--multi">
          <app-button
            [variant]="'outline'"
            (click)="onCancel()"
          >
            Cancelar
          </app-button>

          <div class="modal__footer-actions">
            @if (creationMode === 'manual') {
              <app-button
                [variant]="'primary'"
                (click)="onCreate()"
                [disabled]="!isFormValid()"
              >
                <app-icon name="user" [size]="18" />
                Criar Usuário
              </app-button>
            } @else {
              <app-button
                [variant]="'secondary'"
                (click)="onGenerateLink()"
              >
                <app-icon name="arrow-right" [size]="18" />
                Gerar Link
              </app-button>

              <app-button
                [variant]="'secondary'"
                (click)="onSendEmail()"
                [disabled]="!canSendEmail()"
              >
                <app-icon name="mail" [size]="18" />
                Enviar Link
              </app-button>
            }
          </div>
        </div>
      }
    </div>
  </div>
}
